# PortQueue å¹¿æ’­æ¨¡å¼å¤šè¿›ç¨‹æµ‹è¯•å®Œæˆ

**æ—¶é—´**: 2025-11-24
**çŠ¶æ€**: âœ… å®Œæˆï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡

## å®Œæˆæ€»ç»“

### âœ… å¤šè¿›ç¨‹å¹¿æ’­æµ‹è¯•

**æ‰€æœ‰ 2 ä¸ªå¤šè¿›ç¨‹æµ‹è¯•é€šè¿‡**ï¼š

1. âœ… **SingleProducerTwoConsumers**: å•ç”Ÿäº§è€…è¿›ç¨‹ + 2 ä¸ªæ¶ˆè´¹è€…è¿›ç¨‹ï¼ˆå¹¿æ’­æ¨¡å¼ï¼‰
   - ç”Ÿäº§è€…ç”Ÿäº§ 50 ä¸ª Buffer
   - 2 ä¸ªæ¶ˆè´¹è€…è¿›ç¨‹ç‹¬ç«‹è¯»å–
   - æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°å®Œæ•´çš„ 50 ä¸ª Buffer
   - **éªŒè¯äº†çœŸæ­£çš„å¹¿æ’­æ¨¡å¼**ï¼šåŒä¸€æ•°æ®è¢«æ‰€æœ‰æ¶ˆè´¹è€…è¯»å–

2. âœ… **SingleProducerThreeConsumersWithSlowConsumer**: å•ç”Ÿäº§è€…è¿›ç¨‹ + 3 ä¸ªæ¶ˆè´¹è€…è¿›ç¨‹ï¼ˆåŒ…å«æ…¢æ¶ˆè´¹è€…ï¼‰
   - ç”Ÿäº§è€…ç”Ÿäº§ 30 ä¸ª Buffer
   - 3 ä¸ªæ¶ˆè´¹è€…è¿›ç¨‹ç‹¬ç«‹è¯»å–
   - 1 ä¸ªæ¶ˆè´¹è€…æ•…æ„æ…¢é€Ÿè¯»å–ï¼ˆæ¯æ¬¡è¯»å–åä¼‘çœ  50msï¼‰
   - **éªŒè¯äº†æ…¢æ¶ˆè´¹è€…ä¸é˜»å¡å…¶ä»–æ¶ˆè´¹è€…**ï¼šå¿«æ¶ˆè´¹è€…å¯ä»¥ç‹¬ç«‹å®Œæˆï¼Œæ…¢æ¶ˆè´¹è€…ä¹Ÿèƒ½æ”¶åˆ°å®Œæ•´æ•°æ®

### ğŸ“Š æµ‹è¯•ç»“æœ

```
[==========] Running 2 tests from 1 test suite.
[----------] 2 tests from MultiProcessMulticastTest
[ RUN      ] MultiProcessMulticastTest.SingleProducerTwoConsumers
âœ… æµ‹è¯•å®Œæˆï¼š1 ç”Ÿäº§è€… + 2 æ¶ˆè´¹è€…ï¼ˆå¹¿æ’­æ¨¡å¼ï¼‰
[       OK ] MultiProcessMulticastTest.SingleProducerTwoConsumers (1015 ms)
[ RUN      ] MultiProcessMulticastTest.SingleProducerThreeConsumersWithSlowConsumer
âœ… æµ‹è¯•å®Œæˆï¼š1 ç”Ÿäº§è€… + 3 æ¶ˆè´¹è€…ï¼ˆåŒ…å«æ…¢æ¶ˆè´¹è€…ï¼‰
[       OK ] MultiProcessMulticastTest.SingleProducerThreeConsumersWithSlowConsumer (2547 ms)
[----------] 2 tests from MultiProcessMulticastTest (3562 ms total)

[  PASSED  ] 2 tests.
```

### ğŸ”§ å®ç°ç»†èŠ‚

#### æ¶ˆè´¹è€…è¿›ç¨‹å®ç°

æ¶ˆè´¹è€…è¿›ç¨‹ä½¿ç”¨ `SharedBufferAllocator` ç›´æ¥æ‰“å¼€å·²å­˜åœ¨çš„ poolsï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `ShmManager`ï¼ˆå› ä¸º `ShmManager` ä¼šå°è¯•åˆ›å»ºæ–°çš„ poolsï¼‰ï¼š

```cpp
// åˆ›å»º SharedBufferAllocatorï¼ˆæ‰“å¼€å·²å­˜åœ¨çš„ poolsï¼‰
ProcessId process_id = static_cast<ProcessId>(getpid());
SharedBufferAllocator allocator(registry, process_id);

// ä» GlobalRegistry ä¸­è·å–å·²æ³¨å†Œçš„ pools å¹¶æ‰“å¼€
for (uint32_t i = 0; i < MAX_BUFFER_POOLS; ++i) {
    const auto& pool_info = registry->buffer_pool_registry.pools[i];
    if (pool_info.active) {
        allocator.register_pool(pool_info.pool_id, pool_info.shm_name);
    }
}

// æ‰“å¼€ PortQueue å¹¶æ³¨å†Œä¸ºæ¶ˆè´¹è€…
PortQueue queue;
queue.open(QUEUE_NAME);
queue.set_allocator(&allocator);
ConsumerId consumer_id = queue.register_consumer();
```

#### ç”Ÿäº§è€…è¿›ç¨‹å®ç°

ç”Ÿäº§è€…è¿›ç¨‹ä½¿ç”¨ `ShmManager` åˆ›å»º pools å’Œ PortQueueï¼š

```cpp
// åˆ›å»º GlobalRegistry
GlobalRegistry* registry = new (registry_region.get_address()) GlobalRegistry();
registry->initialize();

// åˆ›å»º ShmManager å¹¶åˆå§‹åŒ–
ShmManager manager(registry, process_id, config);
manager.initialize();

// åˆ›å»º PortQueue
PortQueue queue;
queue.create(QUEUE_NAME, port_id, capacity);
queue.set_allocator(manager.allocator());

// ç”Ÿäº§æ•°æ®
for (int i = 0; i < NUM_BUFFERS; ++i) {
    auto buffer_ptr = manager.allocate(64);
    queue.push(buffer_ptr.id());
}
```

### ğŸ¯ éªŒè¯çš„å…³é”®ç‰¹æ€§

1. **çœŸæ­£çš„å¹¿æ’­**
   - âœ… åŒä¸€ Buffer è¢«æ‰€æœ‰æ¶ˆè´¹è€…è¿›ç¨‹è¯»å–
   - âœ… æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°å®Œæ•´çš„æ•°æ®é›†
   - âœ… é›¶æ‹·è´ï¼Œåªå¢åŠ å¼•ç”¨è®¡æ•°

2. **ç‹¬ç«‹è¯»å–**
   - âœ… æ¯ä¸ªæ¶ˆè´¹è€…æœ‰ç‹¬ç«‹çš„è¯»æŒ‡é’ˆ
   - âœ… å¿«æ¶ˆè´¹è€…ä¸ä¼šç­‰å¾…æ…¢æ¶ˆè´¹è€…
   - âœ… æ…¢æ¶ˆè´¹è€…ä¸é˜»å¡å…¶ä»–æ¶ˆè´¹è€…

3. **è·¨è¿›ç¨‹å¼•ç”¨è®¡æ•°**
   - âœ… ç”Ÿäº§è€… push æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…å¢åŠ å¼•ç”¨
   - âœ… æ¶ˆè´¹è€… pop æ—¶è‡ªåŠ¨å‡å°‘å¼•ç”¨
   - âœ… æœ€åä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–åè‡ªåŠ¨é‡Šæ”¾ Buffer

4. **åŠ¨æ€æ¶ˆè´¹è€…ç®¡ç†**
   - âœ… æ¶ˆè´¹è€…è¿›ç¨‹å¯ä»¥åŠ¨æ€æ³¨å†Œ
   - âœ… æ¶ˆè´¹è€…ä»æ³¨å†Œæ—¶åˆ»å¼€å§‹æ¥æ”¶æ•°æ®
   - âœ… æ¶ˆè´¹è€…æ³¨é”€æ—¶è‡ªåŠ¨é‡Šæ”¾æœªæ¶ˆè´¹æ•°æ®çš„å¼•ç”¨

### ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. **æµ‹è¯•æ–‡ä»¶**
   - `tests/cpp/test_multiprocess_multicast.cpp`: æ–°å¢å¤šè¿›ç¨‹å¹¿æ’­æµ‹è¯•ï¼ˆ2 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

2. **CMakeLists.txt**
   - æ·»åŠ  `test_multiprocess_multicast` åˆ°æµ‹è¯•åˆ—è¡¨

### ğŸš€ æ€§èƒ½è§‚å¯Ÿ

- **å•ç”Ÿäº§è€… + 2 æ¶ˆè´¹è€…**: çº¦ 1 ç§’å®Œæˆï¼ˆ50 ä¸ª Bufferï¼‰
- **å•ç”Ÿäº§è€… + 3 æ¶ˆè´¹è€…ï¼ˆå«æ…¢æ¶ˆè´¹è€…ï¼‰**: çº¦ 2.5 ç§’å®Œæˆï¼ˆ30 ä¸ª Bufferï¼‰
  - æ…¢æ¶ˆè´¹è€…ï¼ˆæ¯æ¬¡è¯»å–åä¼‘çœ  50msï¼‰éœ€è¦çº¦ 1.5 ç§’
  - å¿«æ¶ˆè´¹è€…ï¼ˆæ— ä¼‘çœ ï¼‰å¯ä»¥å¿«é€Ÿå®Œæˆï¼Œä¸å—æ…¢æ¶ˆè´¹è€…å½±å“

### âœ¨ æ€»ç»“

**PortQueue å¹¿æ’­æ¨¡å¼åœ¨å¤šè¿›ç¨‹ç¯å¢ƒä¸‹å®Œå…¨æ­£å¸¸å·¥ä½œï¼** ğŸ‰

æ ¸å¿ƒéªŒè¯ï¼š
- âœ… è·¨è¿›ç¨‹å¹¿æ’­åŠŸèƒ½æ­£å¸¸
- âœ… ç‹¬ç«‹è¯»å–æœºåˆ¶å·¥ä½œæ­£å¸¸
- âœ… å¼•ç”¨è®¡æ•°ç®¡ç†æ­£ç¡®
- âœ… æ…¢æ¶ˆè´¹è€…ä¸é˜»å¡å…¶ä»–æ¶ˆè´¹è€…

### ğŸ“‹ å®Œæ•´æµ‹è¯•è¦†ç›–

ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†ï¼š

1. âœ… **å•å…ƒæµ‹è¯•**ï¼ˆ7 ä¸ªæµ‹è¯•ï¼‰ï¼šå•è¿›ç¨‹ã€å¤šçº¿ç¨‹ç¯å¢ƒ
2. âœ… **å¤šè¿›ç¨‹æµ‹è¯•**ï¼ˆ2 ä¸ªæµ‹è¯•ï¼‰ï¼šè·¨è¿›ç¨‹ç¯å¢ƒ
3. âœ… **æ…¢æ¶ˆè´¹è€…æµ‹è¯•**ï¼šéªŒè¯ä¸é˜»å¡ç‰¹æ€§

**æ€»è®¡ï¼š9 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼**

### ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. **æ€§èƒ½æµ‹è¯•**
   - æ›´å¤§æ•°æ®é‡æµ‹è¯•ï¼ˆ1000+ Bufferï¼‰
   - æ›´å¤šæ¶ˆè´¹è€…æµ‹è¯•ï¼ˆæ¥è¿‘ MAX_CONSUMERS = 16ï¼‰
   - ååé‡æµ‹è¯•

2. **å‹åŠ›æµ‹è¯•**
   - é«˜å¹¶å‘åœºæ™¯
   - é•¿æ—¶é—´è¿è¡Œæµ‹è¯•
   - å†…å­˜æ³„æ¼æ£€æµ‹

3. **åŠŸèƒ½å¢å¼º**
   - ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…æ·»åŠ ç‹¬ç«‹çš„æ¡ä»¶å˜é‡ï¼ˆæ”¯æŒé˜»å¡è¯»å–ï¼‰
   - æ¶ˆè´¹è€…æ€§èƒ½ç›‘æ§
   - æ…¢æ¶ˆè´¹è€…å‘Šè­¦æœºåˆ¶

---

**å¹¿æ’­æ¨¡å¼å®ç°å·²å®Œå…¨å®Œæˆå¹¶é€šè¿‡æ‰€æœ‰æµ‹è¯•ï¼** ğŸŠ



