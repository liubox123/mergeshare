# å¤šè¿›ç¨‹ä¼˜å…ˆè®¾è®¡åŸåˆ™æ›´æ–°

**æ—¥æœŸ**: 2025-11-24  
**ç‰ˆæœ¬**: v2.1  
**çŠ¶æ€**: è®¾è®¡æ›´æ–°å®Œæˆ

---

## ğŸ¯ æ›´æ–°ç›®æ ‡

æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œ**ä¸¥æ ¼è¦æ±‚æ”¯æŒå¤šè¿›ç¨‹æ¨¡å¼**ï¼Œè€Œä¸æ˜¯ä¼˜å…ˆè€ƒè™‘å•è¿›ç¨‹å¤šçº¿ç¨‹ã€‚æ­¤æ¬¡æ›´æ–°é‡æ–°å¼ºè°ƒäº†å¤šè¿›ç¨‹ä¼˜å…ˆçš„è®¾è®¡åŸåˆ™ï¼Œå¹¶è¯¦ç»†è¯´æ˜äº† Buffer åŒæ­¥æœºåˆ¶åœ¨å¤šè¿›ç¨‹æ¨¡å¼ä¸‹çš„å®ç°ã€‚

---

## ğŸ“ æ ¸å¿ƒå˜æ›´

### 1. æ˜ç¡®è®¾è®¡åŸåˆ™é¡ºåº ğŸ”´

**ä¹‹å‰**ï¼š
```
å•è¿›ç¨‹å¤šçº¿ç¨‹ï¼ˆä¼˜å…ˆï¼‰ â†’ æ‰©å±•åˆ°å¤šè¿›ç¨‹
```

**ç°åœ¨**ï¼š
```
å¤šè¿›ç¨‹æ¶æ„ï¼ˆæ ¸å¿ƒè®¾è®¡ï¼‰ â†’ è‡ªåŠ¨æ”¯æŒ â†’ å•è¿›ç¨‹å¤šçº¿ç¨‹ï¼ˆç‰¹ä¾‹ï¼‰
```

### 2. æ–°å¢æ–‡æ¡£

ğŸ“„ **[MULTIPROCESS_BUFFER_MANAGEMENT.md](../design/MULTIPROCESS_BUFFER_MANAGEMENT.md)**

è¯¦ç»†è¯´æ˜ï¼š
- âœ… å¤šè¿›ç¨‹ä¼˜å…ˆåŸåˆ™
- âœ… å®Œæ•´çš„å…±äº«å†…å­˜å¸ƒå±€
- âœ… BufferMetadata è¯¦ç»†ç»“æ„
- âœ… BufferMetadata Table è®¾è®¡
- âœ… Buffer åˆ†é…æµç¨‹ï¼ˆå¤šè¿›ç¨‹è§†è§’ï¼‰
- âœ… å¼•ç”¨è®¡æ•°æ“ä½œï¼ˆå¤šè¿›ç¨‹å®‰å…¨ï¼‰
- âœ… BufferPtr è®¾è®¡ï¼ˆè¿›ç¨‹æœ¬åœ°åŒ…è£…ï¼‰
- âœ… è·¨è¿›ç¨‹ Buffer ä¼ é€’æœºåˆ¶
- âœ… å•è¿›ç¨‹å¤šçº¿ç¨‹ä½œä¸ºç‰¹ä¾‹
- âœ… è¿›ç¨‹é€€å‡ºæ¸…ç†ï¼ˆæ­£å¸¸/å¼‚å¸¸ï¼‰

### 3. æ›´æ–°ç°æœ‰æ–‡æ¡£

#### 3.1 [ARCHITECTURE_SUMMARY.md](../design/ARCHITECTURE_SUMMARY.md)

**æ–°å¢éƒ¨åˆ†**ï¼š
```markdown
## âš ï¸ æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼šå¤šè¿›ç¨‹ä¼˜å…ˆ

> **ä¸¥æ ¼è¦æ±‚ï¼šæŒ‰å¤šè¿›ç¨‹æ¨¡å¼è®¾è®¡ï¼Œå•è¿›ç¨‹å¤šçº¿ç¨‹åªæ˜¯ç‰¹ä¾‹**

### å…³é”®è¦æ±‚
- æ‰€æœ‰çŠ¶æ€åœ¨å…±äº«å†…å­˜
- è·¨è¿›ç¨‹åŒæ­¥åŸè¯­ï¼ˆinterprocess_mutex, atomicï¼‰
- ä¸ä¾èµ–è¿›ç¨‹å†…å­˜
- åªä¼ é€’ Buffer ID
- ä½¿ç”¨ç›¸å¯¹åç§»
- è·¨è¿›ç¨‹å¼•ç”¨è®¡æ•°
- è¿›ç¨‹å´©æºƒæ¸…ç†
```

#### 3.2 [README.md](../design/README.md)

**æ–°å¢ç« èŠ‚**ï¼š
- ğŸ”´ [MULTIPROCESS_BUFFER_MANAGEMENT.md](./MULTIPROCESS_BUFFER_MANAGEMENT.md) - æ ¸å¿ƒé‡è¦æ–‡æ¡£

---

## ğŸ”‘ å…³é”®è®¾è®¡ç‚¹

### 1. BufferMetadata åœ¨å…±äº«å†…å­˜

```cpp
struct alignas(64) BufferMetadata {
    uint64_t buffer_id;
    uint32_t pool_id;
    uint32_t block_index;
    size_t size;
    
    // è·¨è¿›ç¨‹åŸå­å¼•ç”¨è®¡æ•° âš ï¸
    std::atomic<uint32_t> ref_count;
    
    // æ•°æ®ä½ç½®ï¼ˆç›¸å¯¹åç§»ï¼Œä¸æ˜¯æŒ‡é’ˆï¼‰
    uint64_t data_shm_offset;
    
    // æ—¶é—´æˆ³ä¿¡æ¯
    Timestamp timestamp;
    
    // çŠ¶æ€
    std::atomic<bool> valid;
    
    // æ‰€æœ‰è€…ä¿¡æ¯ï¼ˆç”¨äºæ¸…ç†ï¼‰
    uint32_t creator_process_slot;
    uint64_t alloc_time_ns;
};
```

### 2. BufferMetadata Table

- **å…¨å±€è¡¨**ï¼šåœ¨å…±äº«å†…å­˜ä¸­ï¼Œ4096 ä¸ªæ§½ä½
- **ç©ºé—²é“¾è¡¨**ï¼šä½¿ç”¨åŸå­æ“ä½œç®¡ç†ç©ºé—²æ§½ä½
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨ interprocess_mutex ä¿æŠ¤è¡¨çº§æ“ä½œ
- **æŸ¥æ‰¾**ï¼šæ ¹æ® Buffer ID çº¿æ€§æŸ¥æ‰¾ï¼ˆæœªæ¥å¯ä¼˜åŒ–ä¸ºå“ˆå¸Œè¡¨ï¼‰

### 3. BufferPtr æ˜¯è¿›ç¨‹æœ¬åœ°åŒ…è£…

**å…³é”®ç‚¹**ï¼š
- âœ… BufferPtr ä¸å­˜å‚¨åœ¨å…±äº«å†…å­˜ä¸­
- âœ… åªæ“ä½œå…±äº«å†…å­˜ä¸­çš„ BufferMetadata
- âœ… ææ„æ—¶è‡ªåŠ¨å‡å°‘å¼•ç”¨è®¡æ•°
- âœ… æ”¯æŒæ‹·è´/ç§»åŠ¨è¯­ä¹‰

### 4. è·¨è¿›ç¨‹ Buffer ä¼ é€’

```
Process A                     Shared Memory                  Process B
â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€
allocate(4096)          â†’ BufferMetadata Table
buffer_id = 1001            ref_count = 1

produce_output("out",   â†’ PortQueue
  buffer)                   push(buffer_id = 1001)
                            
~BufferPtr()            â†’ BufferMetadata Table
ref_count--                 ref_count = 1 (é˜Ÿåˆ—æŒæœ‰)

                                                          buffer_id = pop()
                                                          buffer_id = 1001
                                                          
                        â†’ BufferMetadata Table         BufferPtr(1001, ...)
                            ref_count = 2               ref_count++
                            
                                                          process_data(buffer)
                                                          
                                                          ~BufferPtr()
                                                          ref_count--
                                                          
                        â†’ BufferMetadata Table
                            ref_count = 1
                            
                                                          (é˜Ÿåˆ—æ¸…ç†)
                                                          ref_count--
                                                          
                        â†’ BufferMetadata Table
                            ref_count = 0  â† è§¦å‘å›æ”¶
```

### 5. å•è¿›ç¨‹å¤šçº¿ç¨‹è‡ªåŠ¨æ”¯æŒ

**ä¸ºä»€ä¹ˆè‡ªåŠ¨æ”¯æŒ**ï¼š
1. å…±äº«å†…å­˜åœ¨åŒä¸€è¿›ç¨‹å†…ä¹Ÿæ˜¯"å…±äº«"çš„
2. `std::atomic` åœ¨çº¿ç¨‹é—´å’Œè¿›ç¨‹é—´éƒ½æ˜¯å®‰å…¨çš„
3. `interprocess_mutex` åœ¨è¿›ç¨‹å†…ä¹Ÿå¯ä»¥ç”¨ï¼ˆå¼€é”€ç•¥å¤§ï¼‰

**å¯é€‰ä¼˜åŒ–**ï¼š
```cpp
if (is_single_process_mode()) {
    // ä½¿ç”¨ std::mutex æ›¿ä»£ interprocess_mutexï¼ˆæ›´å¿«ï¼‰
    // ä½¿ç”¨è¿›ç¨‹å†…çš„ Buffer æŒ‡é’ˆç¼“å­˜
    // è·³è¿‡æŸäº›è·¨è¿›ç¨‹æ£€æŸ¥
}
```

---

## ğŸ“Š è®¾è®¡å¯¹æ¯”

| è®¾è®¡ç‚¹ | å•è¿›ç¨‹ä¼˜å…ˆï¼ˆé”™è¯¯ï¼‰ | å¤šè¿›ç¨‹ä¼˜å…ˆï¼ˆæ­£ç¡®ï¼‰ |
|--------|-------------------|-------------------|
| **è®¾è®¡èµ·ç‚¹** | çº¿ç¨‹é—´å…±äº« | è¿›ç¨‹é—´å…±äº« |
| **åŒæ­¥åŸè¯­** | std::mutex | interprocess_mutex |
| **å¼•ç”¨è®¡æ•°** | è¿›ç¨‹å†… shared_ptr | å…±äº«å†…å­˜ä¸­çš„ atomic |
| **æ•°æ®åœ°å€** | è¿›ç¨‹å†…æŒ‡é’ˆ | ç›¸å¯¹åç§»é‡ |
| **Buffer ä¼ é€’** | æŒ‡é’ˆä¼ é€’ | Buffer ID ä¼ é€’ |
| **è¿›ç¨‹å´©æºƒå¤„ç†** | ä¸é€‚ç”¨ | å¿ƒè·³ + æ¸…ç† |
| **å•è¿›ç¨‹æ”¯æŒ** | è‡ªç„¶æ”¯æŒ | è‡ªç„¶æ”¯æŒï¼ˆç‰¹ä¾‹ï¼‰ |

---

## âœ… éªŒè¯æ¸…å•

- [x] æ‰€æœ‰çŠ¶æ€åœ¨å…±äº«å†…å­˜
- [x] ä½¿ç”¨ interprocess_mutex/condition
- [x] å¼•ç”¨è®¡æ•°ä½¿ç”¨å…±äº«å†…å­˜ä¸­çš„ atomic
- [x] ä¸ä¼ é€’æŒ‡é’ˆï¼Œåªä¼ é€’ Buffer ID
- [x] æ•°æ®åœ°å€ä½¿ç”¨ç›¸å¯¹åç§»
- [x] BufferPtr æ˜¯è¿›ç¨‹æœ¬åœ°åŒ…è£…
- [x] è·¨è¿›ç¨‹ Buffer ä¼ é€’æœºåˆ¶æ¸…æ™°
- [x] è¿›ç¨‹å´©æºƒæ¸…ç†æœºåˆ¶
- [x] å•è¿›ç¨‹å¤šçº¿ç¨‹ä½œä¸ºç‰¹ä¾‹è‡ªåŠ¨æ”¯æŒ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. [MULTIPROCESS_BUFFER_MANAGEMENT.md](../design/MULTIPROCESS_BUFFER_MANAGEMENT.md) ğŸ”´ **æ ¸å¿ƒ**
2. [ARCHITECTURE_SUMMARY.md](../design/ARCHITECTURE_SUMMARY.md) â­ **æ€»ç»“**
3. [MULTIPROCESS_DESIGN_V2.md](../design/MULTIPROCESS_DESIGN_V2.md) - å¤šè¿›ç¨‹æ¶æ„
4. [MULTISTREAM_SYNC_DESIGN.md](../design/MULTISTREAM_SYNC_DESIGN.md) - å¤šæµåŒæ­¥
5. [README.md](../design/README.md) - è®¾è®¡æ–‡æ¡£ç´¢å¼•

---

## ğŸ¯ ä¸‹ä¸€æ­¥

**ç­‰å¾…ç”¨æˆ·å®¡é˜…**ï¼š
1. è¯·å®¡é˜… [MULTIPROCESS_BUFFER_MANAGEMENT.md](../design/MULTIPROCESS_BUFFER_MANAGEMENT.md)
2. ç¡®è®¤å¤šè¿›ç¨‹ä¼˜å…ˆçš„è®¾è®¡åŸåˆ™æ˜¯å¦ç¬¦åˆè¦æ±‚
3. ç¡®è®¤ Buffer åŒæ­¥æœºåˆ¶åœ¨å¤šè¿›ç¨‹æ¨¡å¼ä¸‹çš„å®ç°æ˜¯å¦æ­£ç¡®
4. å¦‚æœ‰ä»»ä½•ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·åé¦ˆ

**å®¡é˜…é€šè¿‡å**ï¼š
- å¼€å§‹å®æ–½ Phase 1: Runtime æ ¸å¿ƒç»„ä»¶
- å®ç° GlobalRegistryã€BufferPoolã€BufferMetadata Table
- å®ç° SharedBufferAllocator å’Œ BufferPtr
- ç¼–å†™å¤šè¿›ç¨‹å•å…ƒæµ‹è¯•

---

**è®¾è®¡æ›´æ–°å®Œæˆï¼âœ…**

